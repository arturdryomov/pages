<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8"/>

  <title>Superior Testing: Make Fakes not Mocks</title>
  <meta name="description" content="To mock, or not to mock, that is the question."/>
  <meta name="author" content="Artur Dryomov"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <link rel="stylesheet" href="/css/style.css"/>
  <link rel="stylesheet" href="/css/syntax-highlighting.css"/>

  
  <meta name="theme-color" content="#1e2327">

  </head>

<body>

<header>
<nav>
  <ul>
    
    <li class="menu-left"><a href="/">Posts</a></li>
    
    
    <li class="menu-right"><a href="feed://arturdryomov.dev/index.xml">RSS</a></li>
    
    <li class="menu-right"><a href="https://github.com/arturdryomov">GitHub</a></li>
    
  </ul>
</nav>

</header>

<br/>


<div class="meta">

  <h1><span class="title">Superior Testing: Make Fakes not Mocks</span></h1>
  <h3>February 28, 2019</h3>

</div>

<main>
<p>After years of writing and reading tests I’ve discovered that mocking
is either overused or underused. Not sure why exactly it happens
but striking the right balance seems to be a complicated issue.</p>
<p>In this Superior Testing article I’ll show how to replace mocking
in favor of faking and collect benefits.</p>
<h1 id="mocking">Mocking</h1>
<h2 id="sync">Sync</h2>
<p>Let’s say we have a books repository allowing us to get a book based on its ID.
The repository depends on the storage. The resulting code is simple enough.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">interface</span> <span class="nc">BooksStorage</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">fun</span> <span class="nf">getBooks</span><span class="p">():</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Book</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">interface</span> <span class="nc">BooksRepository</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">fun</span> <span class="nf">getBook</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">Book</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Impl</span><span class="p">(</span><span class="n">storage</span><span class="p">:</span> <span class="n">BooksStorage</span><span class="p">)</span> <span class="p">:</span> <span class="n">BooksRepository</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">override</span> <span class="k">fun</span> <span class="nf">getBook</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">=</span> <span class="n">storage</span><span class="p">.</span><span class="n">getBooks</span><span class="p">().</span><span class="n">find</span> <span class="p">{</span> <span class="k">it</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Notice that everything is carefully hidden behind <code>interface</code>. This helps
a lot with abstraction which leads to better inversion of control practices
and utility use-cases (like mocking). Rephrasing
<a href="https://en.wikipedia.org/wiki/Single_Ladies_(Put_a_Ring_on_It)">a modern classic Beyoncé</a>:</p>
<blockquote>
<p>If you like it, then you shoulda put an <code>interface</code> on it.</p></blockquote>
<p>We’ll make a single test for now — to check that the repository returns <code>null</code>
when the storage is blank.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="nd">@Test</span> <span class="k">fun</span> <span class="nf">testBlankStorage</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">storage</span> <span class="p">=</span> <span class="n">mock</span><span class="p">&lt;</span><span class="n">BooksStorage</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">`when`</span><span class="p">(</span><span class="n">getBooks</span><span class="p">()).</span><span class="n">thenReturn</span><span class="p">(</span><span class="n">emptyList</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">repository</span> <span class="p">=</span> <span class="nc">BooksRepository</span><span class="p">.</span><span class="n">Impl</span><span class="p">(</span><span class="n">storage</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">assertThat</span><span class="p">(</span><span class="n">repository</span><span class="p">.</span><span class="n">getBook</span><span class="p">(</span><span class="s2">&#34;ID&#34;</span><span class="p">)).</span><span class="n">isNull</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="reactive">Reactive</h2>
<p>Soon enough we notice that book-related operations block the main thread.
Also, RxJava is <a href="https://www.reddit.com/r/OutOfTheLoop/comments/2ho0gy/where_di_the_so_hot_right_now_meme_come_from/">so hot right now</a>
(or was, I have no idea). The code evolves.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">interface</span> <span class="nc">BooksStorage</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">fun</span> <span class="nf">getBooks</span><span class="p">():</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Book</span><span class="p">&gt;&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">interface</span> <span class="nc">BooksRepository</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">fun</span> <span class="nf">getBook</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">Optional</span><span class="p">&lt;</span><span class="n">Book</span><span class="p">&gt;&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Impl</span><span class="p">(</span><span class="n">storage</span><span class="p">:</span> <span class="n">BooksStorage</span><span class="p">)</span> <span class="p">:</span> <span class="n">BooksRepository</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">override</span> <span class="k">fun</span> <span class="nf">getBook</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">=</span> <span class="n">storage</span><span class="p">.</span><span class="n">getBooks</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">books</span> <span class="o">-&gt;</span> <span class="n">books</span><span class="p">.</span><span class="n">find</span> <span class="p">{</span> <span class="k">it</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span> <span class="p">}.</span><span class="n">toOptional</span><span class="p">()</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The relevant test needs to be modified as well.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="nd">@Test</span> <span class="k">fun</span> <span class="nf">testBlankStorage</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">storageBooks</span> <span class="p">=</span> <span class="nc">PublishSubject</span><span class="p">.</span><span class="n">create</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Book</span><span class="p">&gt;&gt;()</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">storage</span> <span class="p">=</span> <span class="n">mock</span><span class="p">&lt;</span><span class="n">BooksStorage</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">`when`</span><span class="p">(</span><span class="n">getBooks</span><span class="p">()).</span><span class="n">thenReturn</span><span class="p">(</span><span class="n">storageBooks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">repository</span> <span class="p">=</span> <span class="nc">BooksRepository</span><span class="p">.</span><span class="n">Impl</span><span class="p">(</span><span class="n">storage</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">storageBooks</span><span class="p">.</span><span class="n">onNext</span><span class="p">(</span><span class="n">emptyList</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">repository</span><span class="p">.</span><span class="n">getBook</span><span class="p">(</span><span class="s2">&#34;ID&#34;</span><span class="p">).</span><span class="n">assertValuesOnly</span><span class="p">(</span><span class="n">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="lessons-learned">Lessons Learned</h2>
<h3 id="good">Good</h3>
<ul>
<li>Mocking works and works well.</li>
</ul>
<h3 id="meh">Meh</h3>
<ul>
<li>More complicated the code becomes — the bulkier mocking feels.
This scales linearly.</li>
<li>Reusability is minor at best.
Producing another test will require the same mocking all over again.</li>
<li>The implicit dependency on the mocking framework actually exists but is carefully forgotten.
This might not seem like an issue but maintaining mocking tools is a dangerous
idea — magic is not cheap and certainly is not trivial.</li>
</ul>
<h1 id="faking">Faking</h1>
<p>Instead of mocking let’s produce reusable fakes using language instruments and nothing else.</p>
<blockquote>
<p>&#x1f4d6; Fakes might be called stubs or dummies —
<a href="http://xunitpatterns.com/Mocks,%20Fakes,%20Stubs%20and%20Dummies.html">depends on the material</a>.
I suggest calling them <em>test implementations</em>.</p></blockquote>
<h2 id="sync-1">Sync</h2>
<p>The implementation is not complicated at all.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">TestBooksStorage</span> <span class="p">:</span> <span class="n">BooksStorage</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">var</span> <span class="py">getBookResult</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">override</span> <span class="k">fun</span> <span class="nf">getBook</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">=</span> <span class="n">getBookResult</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The relevant test changes, but not by a huge margin.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="nd">@Test</span> <span class="k">fun</span> <span class="nf">testBlankStorage</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">storage</span> <span class="p">=</span> <span class="n">TestBooksStorage</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">getBookResult</span> <span class="p">=</span> <span class="k">null</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">repository</span> <span class="p">=</span> <span class="nc">BooksRepository</span><span class="p">.</span><span class="n">Impl</span><span class="p">(</span><span class="n">storage</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">assertThat</span><span class="p">(</span><span class="n">repository</span><span class="p">.</span><span class="n">getBook</span><span class="p">(</span><span class="s2">&#34;ID&#34;</span><span class="p">)).</span><span class="n">isNull</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="reactive-1">Reactive</h2>
<p>Basically the same thing as the sync variant.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">TestBooksStorage</span> <span class="p">:</span> <span class="n">BooksStorage</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">books</span> <span class="p">=</span> <span class="nc">PublishSubject</span><span class="p">.</span><span class="n">create</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Book</span><span class="p">&gt;&gt;()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">override</span> <span class="k">fun</span> <span class="nf">getBooks</span><span class="p">()</span> <span class="p">=</span> <span class="n">books</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="nd">@Test</span> <span class="k">fun</span> <span class="nf">testBlankStorage</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">storage</span> <span class="p">=</span> <span class="n">TestBooksStorage</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">repository</span> <span class="p">=</span> <span class="nc">BooksRepository</span><span class="p">.</span><span class="n">Impl</span><span class="p">(</span><span class="n">storage</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">storage</span><span class="p">.</span><span class="n">books</span><span class="p">.</span><span class="n">onNext</span><span class="p">(</span><span class="n">emptyList</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">repository</span><span class="p">.</span><span class="n">getBook</span><span class="p">(</span><span class="s2">&#34;ID&#34;</span><span class="p">).</span><span class="n">assertValuesOnly</span><span class="p">(</span><span class="n">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>There is an interesting note though. If we transform <code>BooksStorage</code> to use
<code>val</code> instead of <code>fun</code> we’ll be able to use a more compact notation.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">interface</span> <span class="nc">BooksStorage</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">books</span><span class="p">:</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Book</span><span class="p">&gt;&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">TestBooksStorage</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">override</span> <span class="k">val</span> <span class="py">books</span> <span class="p">=</span> <span class="nc">PublishSubject</span><span class="p">.</span><span class="n">create</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Book</span><span class="p">&gt;&gt;()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="nd">@Test</span> <span class="k">fun</span> <span class="nf">testBlankStorage</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">storage</span> <span class="p">=</span> <span class="n">TestBooksStorage</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">repository</span> <span class="p">=</span> <span class="nc">BooksRepository</span><span class="p">.</span><span class="n">Impl</span><span class="p">(</span><span class="n">storage</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">storage</span><span class="p">.</span><span class="n">books</span><span class="p">.</span><span class="n">onNext</span><span class="p">(</span><span class="n">emptyList</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">repository</span><span class="p">.</span><span class="n">getBook</span><span class="p">(</span><span class="s2">&#34;ID&#34;</span><span class="p">).</span><span class="n">assertValuesOnly</span><span class="p">(</span><span class="n">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>This is possible because in Kotlin referencing an <code>interface</code> implementation
gives access to underlying types. In this particular case <code>books</code>
is an <code>Observable</code> but we reference it as <code>PublishSubject</code> because we have access
to the actual implementation. Use it as an advantage in tests but avoid
in inversion of control containers since essentially it might lead
to leaking implementation details.</p>
<h2 id="lessons-learned-1">Lessons Learned</h2>
<h3 id="good-1">Good</h3>
<ul>
<li>Test implementations are implemented as dedicated reusable components.</li>
<li>In particular cases faking is less verbose than mocking.</li>
<li>It is possible to sugar-coat fakes with DSL-ish operators like <code>BooksStorage.emitBooks()</code>.</li>
<li>There is no external dependency on the mocking provider.</li>
</ul>
<h3 id="meh-1">Meh</h3>
<ul>
<li>Faking requires manual implementation.
Might be resolved with code-generation though.</li>
</ul>
<h1 id="lessons-learned-again">Lessons Learned (Again!)</h1>
<p>I think mocking vs. faking is a classic easy vs. simple scenario.
It is relatively easy to mock things left and right but is it simple
on the scale of the entire codebase? Is it understandable and maintainable?
Does it help to make universal and effective tests?
It depends on the exact use-case of course. But please, avoid using a microscope
as a hammer.</p>

</main>


<hr/>

<footer>
<nav>
  <ul>
    
    <li class="menu-left"><a href="/">Posts</a></li>
    
    
    <li class="menu-right"><a href="feed://arturdryomov.dev/index.xml">RSS</a></li>
    
    <li class="menu-right"><a href="https://github.com/arturdryomov">GitHub</a></li>
    
  </ul>
</nav>

</footer>


</body>

</html>


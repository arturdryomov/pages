<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8"/>

  <title>Music Stats with DuckDB</title>
  <meta name="description" content="Using DuckDB for ad-hoc SQL"/>
  <meta name="author" content="Artur Dryomov"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <link rel="stylesheet" href="/css/style.css"/>
  <link rel="stylesheet" href="/css/syntax-highlighting.css"/>

  
  <meta name="theme-color" content="#1e2327">

  </head>

<body>

<header>
<nav>
  <ul>
    
    <li class="menu-left"><a href="/">Posts</a></li>
    
    
    <li class="menu-right"><a href="feed://arturdryomov.dev/index.xml">RSS</a></li>
    
    <li class="menu-right"><a href="https://github.com/arturdryomov">GitHub</a></li>
    
  </ul>
</nav>

</header>

<br/>


<div class="meta">

  <h1><span class="title">Music Stats with DuckDB</span></h1>
  <h3>June 5, 2023</h3>

</div>

<main>
<p>Music! Everyone likes music. Well, I certainly hope so.
Stats! Well, not everyone likes stats but I certainly do.</p>
<p>In this article Iâ€™ll describe an approach to work with
<a href="https://en.wikipedia.org/wiki/Last.fm#Scrobbling">music scrobbles</a>
from different sources and in different formats using <a href="https://duckdb.org/">DuckDB</a>.
DuckDB is a perfect match for such ad-hoc scenarios â€” it has a minimal
footprint, great performance and useful features.</p>
<h1 id="scrobbles">Scrobbles</h1>
<p>Iâ€™ve been using multiple music sources over the past decade.
Fortunately, I had a <a href="https://en.wikipedia.org/wiki/Last.fm">Last.fm</a> account from the beginning.
It allowed me to track almost everything Iâ€™ve listened â€” resulting in almost 110+ thousands of scrobbles.
Unfortunately, I havenâ€™t used it all the time.</p>
<ul>
<li>07.2008 â€” 03.2014: local music files
<ul>
<li>Iâ€™ve used various Linux music players with the Last.fm scrobbling enabled.</li>
</ul>
</li>
<li>04.2014 â€” 09.2022: Spotify
<ul>
<li><a href="https://support.last.fm/t/spotify-scrobbling/189">It is supported as a Last.fm scrobbling source</a> but it wasnâ€™t enabled for me until 04.2019.</li>
</ul>
</li>
<li>10.2022 â€” now: <a href="https://bandcamp.com/">Bandcamp</a>, CDs
<ul>
<li>At this point I donâ€™t track scrobbles but attempt to create a local music collection instead.</li>
</ul>
</li>
</ul>
<p>Last.fm seems to be a good source of truth for scrobbles but
its data is inconsistent due to the lack of scrobbling from Spotify for a period of time.
However, the complete data still can be assembled.</p>
<ul>
<li>Thanks to GDPR itâ€™s possible to request the listening history from streaming services.
See <a href="https://support.stats.fm/docs/import/spotify-import/">steps for Spotify</a> and <a href="https://support.apple.com/en-us/HT208502">for Apple Music</a>.</li>
<li>The Last.fm data retrieval is much easier â€” there is <a href="https://www.last.fm/api/show/user.getRecentTracks">a public API</a>.
There are multiple online tools which call the API and prepare a combined report â€” thatâ€™s what Iâ€™ve used.</li>
</ul>
<h1 id="duckdb-import">DuckDB Import</h1>
<h2 id="spotify">Spotify</h2>
<p>There are 50+ files in the Spotify data export.
There is even a couple of documentation files â€” a welcome surprise.
The listening history is available at multiple <code>MyData/endsong_*.json</code> files.
Each JSON file has the following format.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ts&#34;</span><span class="p">:</span> <span class="s2">&#34;2017-04-08T06:48:15Z&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;username&#34;</span><span class="p">:</span> <span class="s2">&#34;username&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;platform&#34;</span><span class="p">:</span> <span class="s2">&#34;unknown&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ms_played&#34;</span><span class="p">:</span> <span class="mi">223646</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;conn_country&#34;</span><span class="p">:</span> <span class="s2">&#34;PL&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ip_addr_decrypted&#34;</span><span class="p">:</span> <span class="s2">&#34;1.1.1.1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;user_agent_decrypted&#34;</span><span class="p">:</span> <span class="s2">&#34;unknown&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;master_metadata_track_name&#34;</span><span class="p">:</span> <span class="s2">&#34;Good Man&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;master_metadata_album_artist_name&#34;</span><span class="p">:</span> <span class="s2">&#34;Raphael Saadiq&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;master_metadata_album_album_name&#34;</span><span class="p">:</span> <span class="s2">&#34;Stone Rollin&#39;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;spotify_track_uri&#34;</span><span class="p">:</span> <span class="s2">&#34;spotify:track:5jJOShacQWvCDHZgMhl8Zu&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;episode_name&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;episode_show_name&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;spotify_episode_uri&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;reason_start&#34;</span><span class="p">:</span> <span class="s2">&#34;clickrow&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;reason_end&#34;</span><span class="p">:</span> <span class="s2">&#34;unknown&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;shuffle&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;skipped&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;offline&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;offline_timestamp&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;incognito_mode&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></div><p>Besides merging podcasts and music in the same enumeration, the format is good.
Itâ€™s great for DuckDB since it can recognize JSON array items as rows and repeating JSON fields as columns.</p>
<blockquote>
<p>ğŸ’¡ Note that itâ€™s possible to import multiple files using a file name mask.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">scrobbles_spotify</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">read_json_auto</span><span class="p">(</span><span class="s1">&#39;MyData/endsong_*.json&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">DESCRIBE</span><span class="w"> </span><span class="n">scrobbles_spotify</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><pre tabindex="0"><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”
â”‚            column_name            â”‚ column_type â”‚  null   â”‚   key   â”‚ default â”‚ extra â”‚
â”‚              varchar              â”‚   varchar   â”‚ varchar â”‚ varchar â”‚ varchar â”‚ int32 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ts                                â”‚ TIMESTAMP   â”‚ YES     â”‚         â”‚         â”‚       â”‚
â”‚ username                          â”‚ VARCHAR     â”‚ YES     â”‚         â”‚         â”‚       â”‚
â”‚ platform                          â”‚ VARCHAR     â”‚ YES     â”‚         â”‚         â”‚       â”‚
â”‚ ms_played                         â”‚ BIGINT      â”‚ YES     â”‚         â”‚         â”‚       â”‚
â”‚ conn_country                      â”‚ VARCHAR     â”‚ YES     â”‚         â”‚         â”‚       â”‚
â”‚ ip_addr_decrypted                 â”‚ VARCHAR     â”‚ YES     â”‚         â”‚         â”‚       â”‚
â”‚ user_agent_decrypted              â”‚ VARCHAR     â”‚ YES     â”‚         â”‚         â”‚       â”‚
â”‚ master_metadata_track_name        â”‚ VARCHAR     â”‚ YES     â”‚         â”‚         â”‚       â”‚
â”‚ master_metadata_album_artist_name â”‚ VARCHAR     â”‚ YES     â”‚         â”‚         â”‚       â”‚
â”‚ master_metadata_album_album_name  â”‚ VARCHAR     â”‚ YES     â”‚         â”‚         â”‚       â”‚
â”‚ spotify_track_uri                 â”‚ VARCHAR     â”‚ YES     â”‚         â”‚         â”‚       â”‚
â”‚ episode_name                      â”‚ VARCHAR     â”‚ YES     â”‚         â”‚         â”‚       â”‚
â”‚ episode_show_name                 â”‚ VARCHAR     â”‚ YES     â”‚         â”‚         â”‚       â”‚
â”‚ spotify_episode_uri               â”‚ VARCHAR     â”‚ YES     â”‚         â”‚         â”‚       â”‚
â”‚ reason_start                      â”‚ VARCHAR     â”‚ YES     â”‚         â”‚         â”‚       â”‚
â”‚ reason_end                        â”‚ VARCHAR     â”‚ YES     â”‚         â”‚         â”‚       â”‚
â”‚ shuffle                           â”‚ BOOLEAN     â”‚ YES     â”‚         â”‚         â”‚       â”‚
â”‚ skipped                           â”‚ BOOLEAN     â”‚ YES     â”‚         â”‚         â”‚       â”‚
â”‚ offline                           â”‚ BOOLEAN     â”‚ YES     â”‚         â”‚         â”‚       â”‚
â”‚ offline_timestamp                 â”‚ BIGINT      â”‚ YES     â”‚         â”‚         â”‚       â”‚
â”‚ incognito_mode                    â”‚ BOOLEAN     â”‚ YES     â”‚         â”‚         â”‚       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 21 rows                                                                     6 columns â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre><p>Neat! Column types were recognized â€” even <a href="https://en.wikipedia.org/wiki/ISO_8601">ISO 8601</a> time strings were recognized as <code>TIMESTAMP</code>.</p>
<h2 id="lastfm">Last.fm</h2>
<p>There is a single CSV file and its as simple as it gets.</p>
<pre tabindex="0"><code class="language-csv" data-lang="csv">uts,utc_time,artist,artist_mbid,album,album_mbid,track,track_mbid
&#34;1667306723&#34;,&#34;01 Nov 2022, 12:45&#34;,&#34;How to Destroy Angels&#34;,&#34;143b396d-a678-43aa-8c74-628fea8e381f&#34;,&#34;How to Destroy Angels&#34;,&#34;4617ac46-8e11-4a14-9133-b00ecbae7069&#34;,&#34;Parasite&#34;,&#34;5aa91266-1d8b-3ede-bd97-ef4d5e921d4f&#34;
</code></pre><blockquote>
<p>ğŸ’¡ <code>*_mbid</code> fields are <a href="https://musicbrainz.org/">MusicBrainz</a> IDs.</p>
</blockquote>
<p>A CSV file is essentially a table so there are no issues with the DuckDB import.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">scrobbles_lastfm</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">read_csv_auto</span><span class="p">(</span><span class="s1">&#39;recenttracks.csv&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">DESCRIBE</span><span class="w"> </span><span class="n">scrobbles_lastfm</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><pre tabindex="0"><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”
â”‚ column_name â”‚ column_type â”‚  null   â”‚   key   â”‚ default â”‚ extra â”‚
â”‚   varchar   â”‚   varchar   â”‚ varchar â”‚ varchar â”‚ varchar â”‚ int32 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ uts         â”‚ BIGINT      â”‚ YES     â”‚         â”‚         â”‚       â”‚
â”‚ utc_time    â”‚ VARCHAR     â”‚ YES     â”‚         â”‚         â”‚       â”‚
â”‚ artist      â”‚ VARCHAR     â”‚ YES     â”‚         â”‚         â”‚       â”‚
â”‚ artist_mbid â”‚ VARCHAR     â”‚ YES     â”‚         â”‚         â”‚       â”‚
â”‚ album       â”‚ VARCHAR     â”‚ YES     â”‚         â”‚         â”‚       â”‚
â”‚ album_mbid  â”‚ VARCHAR     â”‚ YES     â”‚         â”‚         â”‚       â”‚
â”‚ track       â”‚ VARCHAR     â”‚ YES     â”‚         â”‚         â”‚       â”‚
â”‚ track_mbid  â”‚ VARCHAR     â”‚ YES     â”‚         â”‚         â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre><p>Unlike the Spotify import, the timestamp is not recognized out of the box.
This is not needed for steps below but itâ€™s possible to specify the time format for a proper <code>TIMESTAMP</code> conversion.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">utc_time</span><span class="p">,</span><span class="w"> </span><span class="n">artist</span><span class="p">,</span><span class="w"> </span><span class="n">track</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">read_csv_auto</span><span class="p">(</span><span class="s1">&#39;recenttracks.csv&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">timestampformat</span><span class="o">=</span><span class="s1">&#39;%d %b %Y, %H:%M&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><pre tabindex="0"><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      utc_time       â”‚        artist         â”‚        track         â”‚
â”‚      timestamp      â”‚        varchar        â”‚       varchar        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2021-11-01 12:45:00 â”‚ How to Destroy Angels â”‚ Parasite             â”‚
â”‚ 2021-11-01 12:41:00 â”‚ How to Destroy Angels â”‚ The Space in Between â”‚
â”‚ 2021-11-01 12:38:00 â”‚ Karen Elson           â”‚ We&#39;ll Meet Again     â”‚
â”‚ 2021-11-01 12:33:00 â”‚ Karen Elson           â”‚ Dancing On My Own    â”‚
â”‚ 2021-11-01 12:29:00 â”‚ Karen Elson           â”‚ Sacrifice            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre><h1 id="duckdb-queries">DuckDB Queries</h1>
<p>As a result of the successful import, there are two tables:</p>
<ul>
<li><code>scrobbles_lastfm</code> â€” scrobbles from the Last.fm data export;</li>
<li><code>scrobbles_spotify</code> â€” scrobbles from the Spotify data export.</li>
</ul>
<p>For a unified combined picture tables need to be merged with some adjustments:</p>
<ul>
<li><code>scrobbles_lastfm</code> â€” nothing since <a href="https://www.last.fm/api/scrobbling#when-is-a-scrobble-a-scrobble">Last.fm is strict</a> with incoming scrobbles;</li>
<li><code>scrobbles_spotify</code> â€” filter out doublicate scrobbles from Last.fm, incomplete and short scrobbles.</li>
</ul>
<p>The resulting SQL is straightforward. This one in particular outputs scrobbles per album.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">WITH</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">scrobbles_spotify_</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">master_metadata_track_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">track</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">master_metadata_album_artist_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">artist</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">master_metadata_album_album_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">album</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">scrobbles_spotify</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">-- Avoid scrobbles available at Last.fm
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">      </span><span class="n">ts</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="s1">&#39;2014-04-01&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="s1">&#39;2019-03-31&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">-- Avoid short scrobbles
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">      </span><span class="k">AND</span><span class="w"> </span><span class="n">ms_played</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">-- Avoid incomplete scrobbles
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">      </span><span class="k">AND</span><span class="w"> </span><span class="n">master_metadata_track_name</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">AND</span><span class="w"> </span><span class="n">master_metadata_album_artist_name</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">AND</span><span class="w"> </span><span class="n">master_metadata_album_album_name</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">scrobbles</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">track</span><span class="p">,</span><span class="w"> </span><span class="n">artist</span><span class="p">,</span><span class="w"> </span><span class="n">album</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">scrobbles_lastfm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">track</span><span class="p">,</span><span class="w"> </span><span class="n">artist</span><span class="p">,</span><span class="w"> </span><span class="n">album</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">scrobbles_spotify_</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">artist</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">album</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">scrobbles_count</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">scrobbles</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">artist</span><span class="p">,</span><span class="w"> </span><span class="n">album</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">scrobbles_count</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">5</span><span class="w">
</span></span></span></code></pre></div><pre tabindex="0"><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            artist             â”‚             album             â”‚ scrobbles_count â”‚
â”‚            varchar            â”‚            varchar            â”‚      int64      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Bonobo                        â”‚ Black Sands                   â”‚            1381 â”‚
â”‚ DJ Shadow                     â”‚ The Private Press             â”‚            1018 â”‚
â”‚ DJ Shadow                     â”‚ The Less You Know, The Better â”‚             920 â”‚
â”‚ The White Stripes             â”‚ De Stijl                      â”‚             796 â”‚
â”‚ Zero 7                        â”‚ Simple Things                 â”‚             787 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 5 rows                                                                3 columns â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre><p>Since the resulting database can be treated as a regular SQL-compliant database,
itâ€™s possible to do lots of things. For example:</p>
<ul>
<li>calculate stats per time interval, per artist, per album, per track and so on;</li>
<li>export resulting stats <a href="https://duckdb.org/docs/guides/import/json_export.html">to JSON</a> or
<a href="https://duckdb.org/docs/guides/import/csv_export.html">to CSV</a> and visualize them;</li>
<li>combine stats with external data sources and create streaming / local playlists.</li>
</ul>
<h1 id="results">Results</h1>
<p>Doing this experiment was a fun excersize. I think that DuckDB might be a perfect tool
for ad-hoc analysis, especially when it comes to different data sources.
There is no need to set up a Trino cluster, pre-process data for a PostgreSQL import
or even to write a code at all â€” including pre-processing for Pandas / Polars.
Just import and run SQL, no strings attached.</p>

</main>


<hr/>

<footer>
<nav>
  <ul>
    
    <li class="menu-left"><a href="/">Posts</a></li>
    
    
    <li class="menu-right"><a href="feed://arturdryomov.dev/index.xml">RSS</a></li>
    
    <li class="menu-right"><a href="https://github.com/arturdryomov">GitHub</a></li>
    
  </ul>
</nav>

</footer>


</body>

</html>


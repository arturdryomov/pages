<!DOCTYPE html>
<html lang="en-us">
<head>
  <title>Testing Files without Files</title>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="/css/syntax-highlighting.css" />

  
  <meta name="theme-color" content="#1e2327">
</head>

<body>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-112239048-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


<header>
<nav>
  <ul>
    
    <li class="menu-left"><a href="/">Posts</a></li>
    
    
    <li class="menu-right"><a href="/index.xml">RSS</a></li>
    
    <li class="menu-right"><a href="https://github.com/arturdryomov">GitHub</a></li>
    
  </ul>
</nav>

</header>

<br/>


<div class="meta">

  <h1><span class="title">Testing Files without Files</span></h1>
  <h3>February 21, 2022</h3>

</div>

<main>
<p>File operations become less and less common. As users, we store more and more
data in a vendor storage due to its convenience.
I remember <a href="https://en.wikipedia.org/wiki/VCard">the contacts file format</a>
but cannot locate one on a local machine â€”Â I have Google Contacts instead.
As developers, we use datastores â€”
from <a href="https://aws.amazon.com/s3/">S3</a>
to <a href="https://hive.apache.org/">Hive Metastore</a>.
Such datastores are scalable, fault tolerant and cheap.</p>
<p>However, even if files and file systems are hidden behind various APIs â€”
it doesnâ€™t eliminate them. In this article Iâ€™ll show how to use Java fake file systems
to test file interactions. Itâ€™s a fun approach but with its own pros and cons.</p>
<h1 id="overview">Overview</h1>
<p>Letâ€™s imagine that there is a <code>Packages</code> class we want to test.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="k">interface</span> <span class="nc">Packages</span> <span class="p">{</span>

    <span class="k">fun</span> <span class="nf">pack</span><span class="p">(</span><span class="n">files</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">&lt;</span><span class="n">File</span><span class="p">&gt;):</span> <span class="n">File</span>
<span class="p">}</span>
</code></pre></div><p>The <code>pack</code> method receives an enumeration of files and returns a file of the resulting package.</p>
<h1 id="options">Options</h1>
<h2 id="java-io">Java IO</h2>
<p>A classic approach using <a href="https://devdocs.io/openjdk~17/java.base/java/io/file"><code>java.io.File</code></a>.</p>
<p>The (fake) implementation:</p>
<ul>
<li>receives a <code>packagesRoot</code> argument, making it possible to switch it in tests;</li>
<li>creates a blank file at <code>packagesRoot</code>.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="k">interface</span> <span class="nc">Packages</span> <span class="p">{</span>

    <span class="k">fun</span> <span class="nf">pack</span><span class="p">(</span><span class="n">files</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">&lt;</span><span class="n">File</span><span class="p">&gt;):</span> <span class="n">File</span>

    <span class="k">class</span> <span class="nc">Impl</span><span class="p">(</span><span class="k">private</span> <span class="k">val</span> <span class="py">packagesRoot</span><span class="p">:</span> <span class="n">File</span><span class="p">)</span> <span class="p">:</span> <span class="n">Packages</span> <span class="p">{</span>

        <span class="k">override</span> <span class="k">fun</span> <span class="nf">pack</span><span class="p">(</span><span class="n">files</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">&lt;</span><span class="n">File</span><span class="p">&gt;):</span> <span class="n">File</span> <span class="p">{</span>
            <span class="k">val</span> <span class="py">packageFile</span> <span class="p">=</span> <span class="n">File</span><span class="p">(</span><span class="n">packagesRoot</span><span class="p">,</span> <span class="s2">&#34;package.tar&#34;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">packageFile</span><span class="p">.</span><span class="n">apply</span> <span class="p">{</span> <span class="n">createNewFile</span><span class="p">()</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>The corresponding test suite:</p>
<ul>
<li>creates a random directory serving as <code>packagesRoot</code> before each test;</li>
<li>deletes <code>packagesRoot</code> after each test.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="k">class</span> <span class="nc">PackagesTests</span> <span class="p">{</span>

    <span class="k">private</span> <span class="k">lateinit</span> <span class="k">var</span> <span class="py">packagesRoot</span><span class="p">:</span> <span class="n">File</span>
    <span class="k">private</span> <span class="k">lateinit</span> <span class="k">var</span> <span class="py">packages</span><span class="p">:</span> <span class="n">Packages</span>

    <span class="nd">@BeforeEach</span>
    <span class="k">private</span> <span class="k">fun</span> <span class="nf">setUp</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">packagesRoot</span> <span class="p">=</span> <span class="n">createTempDir</span><span class="p">()</span>
        <span class="n">packages</span> <span class="p">=</span> <span class="n">Packages</span><span class="p">.</span><span class="n">Impl</span><span class="p">(</span><span class="n">packagesRoot</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nd">@AfterEach</span>
    <span class="k">private</span> <span class="k">fun</span> <span class="nf">tearDown</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">packagesRoot</span><span class="p">.</span><span class="n">deleteRecursively</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">pack</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">val</span> <span class="py">files</span> <span class="p">=</span> <span class="p">(</span><span class="m">0.</span><span class="p">.</span><span class="m">10</span><span class="p">)</span>
            <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">File</span><span class="p">(</span><span class="n">packagesRoot</span><span class="p">,</span> <span class="s2">&#34;</span><span class="si">$it</span><span class="s2">.txt&#34;</span><span class="p">)</span> <span class="p">}</span>
            <span class="p">.</span><span class="n">onEach</span> <span class="p">{</span> <span class="k">it</span><span class="p">.</span><span class="n">createNewFile</span><span class="p">()</span> <span class="p">}</span>

        <span class="n">assertThat</span><span class="p">(</span><span class="n">packages</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">files</span><span class="p">)).</span><span class="n">exists</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>Pros:</p>
<ul>
<li><code>java.io.File</code> is available from Java 1;</li>
<li>uses the same API as the implementation (no potential surprises).</li>
</ul>
<p>Cons:</p>
<ul>
<li>creates disk file descriptors,
polluting <a href="https://en.wikipedia.org/wiki/Inode">the <code>inode</code> space</a>;</li>
<li>disk operations are blocking and are not that fast even with SSD;</li>
<li>easy to forget removing files after each test.</li>
</ul>
<h2 id="java-nio">Java NIO</h2>
<p>A modern approach with <a href="https://devdocs.io/openjdk~17/java.base/java/nio/file/path"><code>java.nio.file.Path</code></a>.
It might feel new but the NIO is available from Java 7 (2011).</p>
<blockquote>
<p>ðŸ’¡ Hello there, a curious Android developer.
<code>java.nio.file.*</code> is available from API 26 (8.0).</p>
</blockquote>
<p>Both the interface and the implementation need changes:</p>
<ul>
<li><code>java.io.File</code> becomes <code>java.nio.file.Path</code>;</li>
<li><code>java.io.File</code> mutation calls are done via <code>java.nio.file.Files</code>;</li>
<li><code>java.nio.file.Path</code> uses <code>java.nio.file.FileSystem</code> under the hood.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="k">interface</span> <span class="nc">Packages</span> <span class="p">{</span>

    <span class="k">fun</span> <span class="nf">pack</span><span class="p">(</span><span class="n">files</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">&lt;</span><span class="n">Path</span><span class="p">&gt;):</span> <span class="n">Path</span>

    <span class="k">class</span> <span class="nc">Impl</span><span class="p">(</span><span class="k">private</span> <span class="k">val</span> <span class="py">packagesRoot</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="p">:</span> <span class="n">Packages</span> <span class="p">{</span>

        <span class="k">override</span> <span class="k">fun</span> <span class="nf">pack</span><span class="p">(</span><span class="n">files</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">&lt;</span><span class="n">Path</span><span class="p">&gt;):</span> <span class="n">Path</span> <span class="p">{</span>
            <span class="k">val</span> <span class="py">packageFile</span> <span class="p">=</span> <span class="n">packagesRoot</span><span class="p">.</span><span class="n">resolve</span><span class="p">(</span><span class="s2">&#34;package.tar&#34;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">packageFile</span><span class="p">.</span><span class="n">apply</span> <span class="p">{</span> <span class="n">Files</span><span class="p">.</span><span class="n">createFile</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>The corresponding test suite:</p>
<ul>
<li>creates a fake file system using JimFS before each test;</li>
<li>provides <code>packagesRoot</code> via the fake file system;</li>
<li>closes the fake file system after each test.</li>
</ul>
<p><a href="https://github.com/google/jimfs">JimFS</a> is
an in-memory <code>java.nio.file.FileSystem</code> implementation.
Nope, it wasnâ€™t created by <a href="https://theoffice.fandom.com/wiki/Jim_Halpert">Jim from The Office</a>.
It means Just In Memory File System. It doesnâ€™t use disk at all.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="k">class</span> <span class="nc">PackagesTests</span> <span class="p">{</span>

    <span class="k">private</span> <span class="k">lateinit</span> <span class="k">var</span> <span class="py">packagesFileSystem</span><span class="p">:</span> <span class="n">FileSystem</span>
    <span class="k">private</span> <span class="k">lateinit</span> <span class="k">var</span> <span class="py">packages</span><span class="p">:</span> <span class="n">Packages</span>

    <span class="nd">@BeforeEach</span>
    <span class="k">fun</span> <span class="nf">setUp</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">packagesFileSystem</span> <span class="p">=</span> <span class="n">Jimfs</span><span class="p">.</span><span class="n">newFileSystem</span><span class="p">()</span>

        <span class="n">packages</span> <span class="p">=</span> <span class="n">Packages</span><span class="p">.</span><span class="n">Impl</span><span class="p">(</span>
            <span class="n">packagesRoot</span> <span class="p">=</span> <span class="n">packagesFileSystem</span><span class="p">.</span><span class="n">getPath</span><span class="p">(</span><span class="s2">&#34;packages&#34;</span><span class="p">).</span><span class="n">apply</span> <span class="p">{</span>
                <span class="n">Files</span><span class="p">.</span><span class="n">createDirectory</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
            <span class="p">},</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="nd">@AfterEach</span>
    <span class="k">fun</span> <span class="nf">tearDown</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">packagesFileSystem</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">pack</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">val</span> <span class="py">files</span> <span class="p">=</span> <span class="p">(</span><span class="m">0.</span><span class="p">.</span><span class="m">10</span><span class="p">)</span>
            <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">packagesFileSystem</span><span class="p">.</span><span class="n">getPath</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">$it</span><span class="s2">.txt&#34;</span><span class="p">)</span> <span class="p">}</span>
            <span class="p">.</span><span class="n">onEach</span> <span class="p">{</span> <span class="n">Files</span><span class="p">.</span><span class="n">createFile</span><span class="p">(</span><span class="k">it</span><span class="p">)</span> <span class="p">}</span>

        <span class="n">assertThat</span><span class="p">(</span><span class="n">packages</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">files</span><span class="p">)).</span><span class="n">exists</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>Pros:</p>
<ul>
<li>no disk interaction meaning better performance;</li>
<li>itâ€™s possible to test different platforms behavior via
<a href="https://github.com/google/jimfs/blob/323826d63eade769a606faa9666b9460ccf67795/jimfs/src/main/java/com/google/common/jimfs/Configuration.java#L169-L173">configurations</a>.</li>
</ul>
<p>Cons:</p>
<ul>
<li>requires a migration from <code>java.io.File</code> to <code>java.nio.file.*</code>;</li>
<li>while there is no need to remove files â€”
there is <a href="https://github.com/google/jimfs/issues/104#issuecomment-619123056">a recommendation</a>
to close JimFS instances.</li>
</ul>
<h2 id="okio">Okio</h2>
<p>I call it a portable NIO since the Java NIO feels like an inspiration for the Okio FS API.
Also itâ€™s <a href="https://github.com/square/okio">a separate artifact</a> and supports Kotlin Multiplatform.</p>
<p>Both the interface and the implementation need changes:</p>
<ul>
<li><code>java.io.File</code> becomes <code>okio.Path</code>;</li>
<li><code>java.io.File</code> mutation calls are done via <code>okio.FileSystem</code>.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="k">interface</span> <span class="nc">Packages</span> <span class="p">{</span>

    <span class="k">fun</span> <span class="nf">pack</span><span class="p">(</span><span class="n">files</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">&lt;</span><span class="n">Path</span><span class="p">&gt;):</span> <span class="n">Path</span>

    <span class="k">class</span> <span class="nc">Impl</span><span class="p">(</span>
        <span class="k">private</span> <span class="k">val</span> <span class="py">packagesFileSystem</span><span class="p">:</span> <span class="n">FileSystem</span><span class="p">,</span>
        <span class="k">private</span> <span class="k">val</span> <span class="py">packagesRoot</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">:</span> <span class="n">Packages</span> <span class="p">{</span>

        <span class="k">override</span> <span class="k">fun</span> <span class="nf">pack</span><span class="p">(</span><span class="n">files</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">&lt;</span><span class="n">Path</span><span class="p">&gt;):</span> <span class="n">Path</span> <span class="p">{</span>
            <span class="k">val</span> <span class="py">packageFile</span> <span class="p">=</span> <span class="n">packagesRoot</span><span class="p">.</span><span class="n">resolve</span><span class="p">(</span><span class="s2">&#34;package.tar&#34;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">packageFile</span><span class="p">.</span><span class="n">apply</span> <span class="p">{</span> <span class="n">packagesFileSystem</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">{}</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>The corresponding test suite:</p>
<ul>
<li>creates a fake file system using <code>FakeFileSystem</code> before each test;</li>
<li>provides <code>packagesRoot</code> via the fake file system.</li>
</ul>
<p>JimFS is not relevant here but there is a neat <code>okio.fakefilesystem.FakeFileSystem</code> doing the same thing.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="k">class</span> <span class="nc">PackagesTests</span> <span class="p">{</span>

    <span class="k">private</span> <span class="k">lateinit</span> <span class="k">var</span> <span class="py">packagesFileSystem</span><span class="p">:</span> <span class="n">FileSystem</span>
    <span class="k">private</span> <span class="k">lateinit</span> <span class="k">var</span> <span class="py">packages</span><span class="p">:</span> <span class="n">Packages</span>

    <span class="nd">@BeforeEach</span>
    <span class="k">fun</span> <span class="nf">setUp</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">packagesFileSystem</span> <span class="p">=</span> <span class="n">FakeFileSystem</span><span class="p">()</span>

        <span class="n">packages</span> <span class="p">=</span> <span class="n">Packages</span><span class="p">.</span><span class="n">Impl</span><span class="p">(</span>
            <span class="n">packagesFileSystem</span> <span class="p">=</span> <span class="n">packagesFileSystem</span><span class="p">,</span>
            <span class="n">packagesRoot</span> <span class="p">=</span> <span class="s2">&#34;packages&#34;</span><span class="p">.</span><span class="n">toPath</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span>
                <span class="n">packagesFileSystem</span><span class="p">.</span><span class="n">createDirectory</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
            <span class="p">},</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">pack</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">val</span> <span class="py">files</span> <span class="p">=</span> <span class="p">(</span><span class="m">0.</span><span class="p">.</span><span class="m">10</span><span class="p">)</span>
            <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="s2">&#34;</span><span class="si">$it</span><span class="s2">.txt&#34;</span><span class="p">.</span><span class="n">toPath</span><span class="p">()</span> <span class="p">}</span>
            <span class="p">.</span><span class="n">onEach</span> <span class="p">{</span> <span class="n">packagesFileSystem</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="k">it</span><span class="p">)</span> <span class="p">{}</span> <span class="p">}</span>

        <span class="n">assertThat</span><span class="p">(</span><span class="n">packagesFileSystem</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">packages</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">files</span><span class="p">))).</span><span class="n">isTrue</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>Pros:</p>
<ul>
<li>no disk interaction meaning better performance;</li>
<li>itâ€™s possible to test different platforms behavior via
<a href="https://square.github.io/okio/3.x/okio-fakefilesystem/okio-fakefilesystem/okio.fakefilesystem/-fake-file-system/emulate-windows.html">configuration calls</a>;</li>
<li>itâ€™s possible to <a href="https://square.github.io/okio/3.x/okio-fakefilesystem/okio-fakefilesystem/okio.fakefilesystem/-fake-file-system/check-no-open-files.html">test for hanging open files</a>.</li>
</ul>
<p>Cons:</p>
<ul>
<li>requires a migration from <code>java.io.File</code> to <code>okio.*</code>;</li>
<li>the implementation is a bit verbose (notice passing <code>FileSystem</code> instances around).</li>
</ul>
<h1 id="options-performance">Options Performance</h1>
<p>Iâ€™ve took execution measurements but please note that this is not a benchmark.</p>
<ul>
<li>CPU: Intel 8257U, RAM: 8 GB LPDDR3, SSD: 250 GB (APFS).</li>
<li>JVM: 17.0.2.</li>
<li>Runs: 10. Each run: create and delete <code>N</code> files.</li>
</ul>
<p>Time in the table is the average run duration.</p>
<table>
<thead>
<tr>
<th><code>N</code></th>
<th>Java IO, ms</th>
<th>Java NIO (JimFS), ms</th>
<th>Okio (<code>FakeFileSystem</code>), ms</th>
</tr>
</thead>
<tbody>
<tr>
<td>100</td>
<td>15</td>
<td>3</td>
<td>4</td>
</tr>
<tr>
<td>1000</td>
<td>100</td>
<td>9</td>
<td>20</td>
</tr>
<tr>
<td>10000</td>
<td>1040</td>
<td>30</td>
<td>95</td>
</tr>
<tr>
<td>100000</td>
<td>15880</td>
<td>160</td>
<td>860</td>
</tr>
</tbody>
</table>
<p>No surprises here â€”Â RAM performs better than SSD.</p>
<p>However, tests creating thousands of files are uncommon. I can imagine having
hundreds of tests (each creating dozens of files) though. Still â€”Â ergonomics
might be a better choosing criteria here.</p>
<h1 id="decisions">Decisions</h1>
<p>The choice depends on circumstances. As for me â€”Â I think NIO is a great choice
for JVM services, Okio â€”Â for Android applications.
Also â€”Â more than zero tests is awesome, thatâ€™s all that matters.</p>

</main>


<hr/>

<footer>
<nav>
  <ul>
    
    <li class="menu-left"><a href="/">Posts</a></li>
    
    
    <li class="menu-right"><a href="/index.xml">RSS</a></li>
    
    <li class="menu-right"><a href="https://github.com/arturdryomov">GitHub</a></li>
    
  </ul>
</nav>

</footer>


</body>

</html>

